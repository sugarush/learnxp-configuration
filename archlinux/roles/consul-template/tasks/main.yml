---

  - name: copy consul-template from s3
    aws_s3:
      bucket: "{{ bucket }}"
      object: "{{ consul_template }}"
      dest: /tmp/consul-template.pkg.tar.xz
      mode: get

  - name: install consul-template
    command: pacman --noconfirm -U /tmp/consul-template.pkg.tar.xz

  - name: remove config file
    file:
      path: /etc/consul-template/config.hcl
      state: absent

  - name: create /run/consul-template
    file:
      path: /run/consul-template
      owner: consul
      group: consul
      state: directory
      mode: 0770

  - namme: create /etc/consul-template/ directories
    file:
      path: /etc/consul-template/{{ item }}
      owner: consul
      group: consul
      state: directory
      mode: 0770
    with_items:
      - config
      - template

  - name: template consul-template systemd service
    template:
      src: consul-template@.service
      dest: /etc/systemd/system/consul-template@.service
    notify:
      - daemon-reload
