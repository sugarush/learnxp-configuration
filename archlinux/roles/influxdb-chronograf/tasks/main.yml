---

  - name: copy chronograf from s3
    aws_s3:
      bucket: "{{ bucket }}"
      object: "{{ chronograf }}"
      dest: /tmp/chronograf.pkg.tar.xz
      mode: get

  - name: install chronograf
    command: pacman --noconfirm -U /tmp/chronograf.pkg.tar.xz

  - name: add chronograf group
    group:
      name: chronograf
      system: yes

  - name: add chronograf user
    user:
      name: chronograf
      group: chronograf
      system: yes

  - name: set permissions on /etc/chronograf
    file:
      path: /etc/chronograf
      state: directory
      owner: chronograf
      group: chronograf
      mode: 0770

  - name: create /var/lib/chronograf
    file:
      path: /var/lib/chronograf
      state: directory
      owner: chronograf
      group: chronograf
      mode: 0770

  #- name: template chronograf.conf to /etc/chronograf
  #  template:
  #    src: chronograf.toml
  #    dest: /etc/chronograf/chronograf.toml
  #    owner: chronograf
  #    group: chronograf
  #    mode: 0770

  #- name: copy chronograf systemd service file
  #  copy:
  #    src: chronograf.service
  #    dest: /etc/systemd/system/chronograf.service
  #  notify:
  #    - daemon-reload

  - name: template chronograf consul service definition
    template:
      src: chronograf.service.json
      dest: /etc/consul/service/chronograf.service.json
    notify:
      - reload consul@client
      - reload consul@server

  - name: start and enable chronograf
  #  command: systemctl enable --now chronograf
    systemd:
      name: chronograf
      enabled: yes
      state: started
