---

  - name: create vault package directory
    file:
      state: directory
      path: /tmp/vault

  - name: copy packages
    aws_s3:
      bucket: "{{ bucket }}"
      object: "{{ item.value }}"
      dest: "/tmp/vault/{{ item.key }}.pkg.tar.xz"
      mode: get
    with_dict: "{{ packages }}"

  - name: install vault packages
    shell: pacman --noconfirm -U /tmp/vault/*

  - name: remove default vault configuration
    file:
      path: /etc/vault.hcl
      state: absent

  - name: remove default vault systemd service
    file:
      path: /usr/lib/systemd/system/vault.service
      state: absent

  - name: create vault directories
    file:
      path: "{{ item }}"
      state: directory
      mode: 0770
      owner: vault
      group: vault
    with_items:
      - /etc/vault
      - /var/run/vault

  - name: template vault configuration
    template:
      src: vault.hcl
      dest: /etc/vault/vault.hcl
      owner: vault
      group: vault
      mode: 0770
    notify:
      - reload vault

  - name: copy vault systemd service
    copy:
      src: vault.service
      dest: /etc/systemd/system/vault.service

  - name: enable and start vault systemd service
    systemd:
      name: vault
      enabled: yes
      state: started
      daemon_reload: yes
