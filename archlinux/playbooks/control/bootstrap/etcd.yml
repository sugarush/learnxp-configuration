---

    - hosts: tag_Cluster_{{ lookup('env', 'ENVIRONMENT') }}_control

      tasks:

        - name: stop etcd bootstrap
          systemd:
            name: etcd-bootstrap
            state: stopped

        - name: stop etcd server
          systemd:
            name: etcd-server
            state: stopped

        - name: settle...
          pause:
            seconds: 5

        - name: bootstrap etcd cluster
          systemd:
            name: etcd-bootstrap
            state: started

        - name: settle...
          pause:
            seconds: 15


    - hosts: tag_Cluster_{{ lookup('env', 'ENVIRONMENT') }}_control

      serial: 1

      tasks:

        - name: stop etcd-bootstrap
          systemd:
            name: etcd-bootstrap
            state: stopped

        - name: settle...
          pause:
            seconds: 5

        - name: enable and start etcd-server
          systemd:
            name: etcd-server
            state: started
            enabled: yes

        - name: settle...
          pause:
            seconds: 5


    - hosts: tag_Cluster_{{ lookup('env', 'ENVIRONMENT') }}_control

      tasks:

        - name: wait for etcd.service.consul
          wait_for:
            host: "{{ ansible_host }}"
            port: 2379
            delay: 10
